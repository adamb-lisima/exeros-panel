<ng-container *ngIf="{ selectedId: selectedId$ | async, loading: vehiclesLoading$ | async } as ctx">
  <!-- Sort dropdown -->
  <div class="flex items-center justify-between mb-3 px-1">
    <span class="text-caption text-neutral-500">Sort by</span>
    <select
      class="text-body-sm bg-surface-raised border border-neutral-200 rounded-lg px-3 py-1.5 text-neutral-700 cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-1"
      [value]="sortBy"
      (change)="onSortChange($any($event.target).value)">
      <option *ngFor="let opt of sortOptions" [value]="opt.value">{{ opt.label }}</option>
    </select>
  </div>

  <!-- Loading skeleton -->
  <ng-container *ngIf="ctx.loading">
    <div class="flex flex-col gap-3">
      <app-skeleton-loader *ngFor="let i of [1, 2, 3, 4, 5]" variant="table-row"></app-skeleton-loader>
    </div>
  </ng-container>

  <!-- Vehicle list -->
  <ng-container *ngIf="!ctx.loading">
    <app-infinity-scroll *ngIf="vehiclesMeta$ | async as meta" [transparent]="true" [listGap]="true" [pageMeta]="meta" [loading]="false">
      <ng-container list>
        <ng-container *ngIf="sortedVehicles$ | async as vehicles">
          <!-- Empty state -->
          <app-empty-state
            *ngIf="vehicles.length === 0"
            heading="No vehicles found"
            description="No vehicles match your current filters. Try adjusting your search criteria."
            ctaLabel="Clear Filters"
            (ctaClick)="onClearFilters()">
          </app-empty-state>

          <!-- Vehicle card rows -->
          <div
            *ngFor="let vehicle of vehicles; trackBy: trackById"
            class="vehicle-card flex justify-between gap-2 p-4 rounded-xl cursor-pointer border bg-surface-raised transition-all duration-200 hover:shadow-md hover:-translate-y-px"
            [ngClass]="ctx.selectedId === vehicle.id ? 'border-brand-500 shadow-sm' : 'border-neutral-200 shadow-sm'"
            (keydown.enter)="handleVehicleClick(vehicle)"
            (click)="handleVehicleClick(vehicle)">
            <div class="flex items-center gap-3">
              <!-- Vehicle type icon -->
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-neutral-50 flex items-center justify-center">
                <ng-container [ngSwitch]="vehicle.type">
                  <img *ngSwitchCase="'HGV'" ngSrc="assets/svg/icons-gray-back/6.svg" width="32" height="32" alt="HGV" />
                  <img *ngSwitchCase="'VAN'" ngSrc="assets/svg/icons-gray-back/7.svg" width="32" height="32" alt="Van" />
                  <img *ngSwitchCase="'BUS'" ngSrc="assets/svg/icons-gray-back/8.svg" width="32" height="32" alt="Bus" />
                  <img *ngSwitchCase="'COMPANY_CAR'" ngSrc="assets/svg/icons-gray-back/9.svg" width="32" height="32" alt="Company Car" />
                  <img *ngSwitchCase="'TRAIN'" ngSrc="assets/svg/icons-gray-back/10.svg" width="32" height="32" alt="Train" />
                </ng-container>
              </div>

              <!-- Vehicle info -->
              <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2">
                  <p class="font-semibold text-neutral-900">{{ vehicle.registration_plate }}</p>
                  <app-badge
                    [status]="getVehicleStatus(vehicle)"
                    [label]="getStatusLabel(vehicle)">
                  </app-badge>
                </div>
                <p class="text-body-sm text-neutral-500">{{ vehicle.brand_name }} {{ vehicle.model_name }}</p>
              </div>
            </div>

            <!-- Right side: actions + status icons -->
            <div class="flex flex-col justify-between items-end">
              <ng-container *appHasPermission="[[accessGroup.VEHICLES_EDITOR]]">
                <div [cdkMenuTriggerFor]="menu" class="flex items-center gap-1 py-1 px-2 rounded-md cursor-pointer hover:bg-neutral-50 transition-colors">
                  <div class="w-[3px] h-[3px] rounded-full bg-neutral-400"></div>
                  <div class="w-[3px] h-[3px] rounded-full bg-neutral-400"></div>
                  <div class="w-[3px] h-[3px] rounded-full bg-neutral-400"></div>
                </div>
                <ng-template #menu>
                  <div class="flex flex-col border border-neutral-200 rounded-lg bg-surface-raised shadow-md" cdkMenu>
                    <a class="px-4 py-2 text-body-sm cursor-pointer hover:bg-neutral-50 rounded-lg transition-colors" (click)="handleEditCameraChannelsClick(vehicle)" cdkMenuItem>Edit Camera channels</a>
                  </div>
                </ng-template>
              </ng-container>
              <div class="ml-auto items-center mt-auto">
                <app-vehicle-status-icons [hasTelematics]="vehicle.has_telematics" [hasVideo]="vehicle.has_video"></app-vehicle-status-icons>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </app-infinity-scroll>
  </ng-container>
</ng-container>
