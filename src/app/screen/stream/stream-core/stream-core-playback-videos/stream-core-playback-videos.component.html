<div class="h-full flex flex-col gap-4">
  <ng-container *ngIf="playbackTimeline$ | async as playbackTimeline">
    <ng-container *ngIf="playback$ | async as playback">
      <ng-template #noScope>
        <div class="flex flex-col gap-1">
          <div class="flex flex-row gap-1">
            <div class="flex overflow-x-auto justify-center gap-2">
              <p class="flex items-center text-sm">Show channels:</p>
              <ng-container *ngFor="let camera of playback.cameras | slice : 0 : (showAllChannels ? undefined : maxVisibleChannels); trackBy: trackByCamera; let i = index">
                <div class="flex gap-3 py-2 px-2 rounded-xl cursor-pointer font-normal text-sm select-none text-black items-center bg-white border border-neutral-500-300" (click)="handlePlaceholderCameraClick(camera)" (keydown.enter)="handlePlaceholderCameraClick(camera)">
                  <svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 13.8333C11.3807 13.8333 12.5 12.7141 12.5 11.3333C12.5 9.95258 11.3807 8.83333 10 8.83333C8.61925 8.83333 7.5 9.95258 7.5 11.3333C7.5 12.7141 8.61925 13.8333 10 13.8333Z" stroke="currentColor" stroke-width="1.06" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M2.5 14.5V8.16666C2.5 7.23324 2.5 6.76653 2.68166 6.41001C2.84144 6.0964 3.09641 5.84144 3.41002 5.68165C3.76653 5.49999 4.23325 5.49999 5.16667 5.49999H6.04553C6.14798 5.49999 6.19921 5.5 6.24647 5.49458C6.49305 5.46634 6.71421 5.32965 6.84974 5.12174C6.87572 5.08189 6.89863 5.03606 6.94444 4.94444C7.03608 4.76118 7.08189 4.66955 7.13385 4.58985C7.40492 4.17401 7.84723 3.90064 8.34042 3.84415C8.43492 3.83333 8.53733 3.83333 8.74225 3.83333H11.2577C11.4627 3.83333 11.5651 3.83333 11.6596 3.84415C12.1527 3.90064 12.5951 4.17401 12.8662 4.58985C12.9181 4.66954 12.9639 4.7612 13.0556 4.94444C13.1013 5.03607 13.1242 5.08189 13.1502 5.12174C13.2858 5.32965 13.5069 5.46634 13.7535 5.49458C13.8008 5.5 13.852 5.49999 13.9545 5.49999H14.8333C15.7667 5.49999 16.2335 5.49999 16.59 5.68165C16.9036 5.84144 17.1586 6.0964 17.3183 6.41001C17.5 6.76653 17.5 7.23324 17.5 8.16666V14.5C17.5 15.4334 17.5 15.9002 17.3183 16.2567C17.1586 16.5702 16.9036 16.8252 16.59 16.985C16.2335 17.1667 15.7667 17.1667 14.8333 17.1667H5.16667C4.23325 17.1667 3.76653 17.1667 3.41002 16.985C3.09641 16.8252 2.84144 16.5702 2.68166 16.2567C2.5 15.9002 2.5 15.4334 2.5 14.5Z" stroke="currentColor" stroke-width="1.06" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  {{ camera.name }}
                </div>
              </ng-container>

              <div class="relative" *ngIf="playback.cameras.length > maxVisibleChannels">
                <div [matMenuTriggerFor]="tempMenu" #tempMenuTrigger="matMenuTrigger" (click)="$event.stopPropagation()" (keydown.enter)="$event.stopPropagation()" class="flex items-center gap-1 py-3 px-1.5 rounded-md cursor-pointer hover:bg-neutral-100">
                  <div class="flex cursor-pointer mr-2 font-medium text-sm select-none items-center">
                    <span class="underline text-brand-500 ml-auto" *ngIf="!showAllChannels">{{ playback.cameras.length - maxVisibleChannels }} {{ showAllChannels ? 'Show Less' : 'more' }}</span>
                  </div>
                </div>

                <mat-menu #tempMenu="matMenu" [hasBackdrop]="true">
                  <div class="p-2">
                    <div class="flex flex-col gap-2">
                      <ng-container *ngFor="let camera of playback.cameras | slice : maxVisibleChannels; trackBy: trackByCamera">
                        <div class="flex gap-2 py-2 px-2 rounded-xl cursor-pointer font-normal text-sm border select-none items-center bg-neutral-100 border-neutral-500-100" (click)="handlePlaceholderCameraClick(camera)" (keydown.enter)="handlePlaceholderCameraClick(camera)">
                          <svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 13.8333C11.3807 13.8333 12.5 12.7141 12.5 11.3333C12.5 9.95258 11.3807 8.83333 10 8.83333C8.61925 8.83333 7.5 9.95258 7.5 11.3333C7.5 12.7141 8.61925 13.8333 10 13.8333Z" stroke="currentColor" stroke-width="1.06" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M2.5 14.5V8.16666C2.5 7.23324 2.5 6.76653 2.68166 6.41001C2.84144 6.0964 3.09641 5.84144 3.41002 5.68165C3.76653 5.49999 4.23325 5.49999 5.16667 5.49999H6.04553C6.14798 5.49999 6.19921 5.5 6.24647 5.49458C6.49305 5.46634 6.71421 5.32965 6.84974 5.12174C6.87572 5.08189 6.89863 5.03606 6.94444 4.94444C7.03608 4.76118 7.08189 4.66955 7.13385 4.58985C7.40492 4.17401 7.84723 3.90064 8.34042 3.84415C8.43492 3.83333 8.53733 3.83333 8.74225 3.83333H11.2577C11.4627 3.83333 11.5651 3.83333 11.6596 3.84415C12.1527 3.90064 12.5951 4.17401 12.8662 4.58985C12.9181 4.66954 12.9639 4.7612 13.0556 4.94444C13.1013 5.03607 13.1242 5.08189 13.1502 5.12174C13.2858 5.32965 13.5069 5.46634 13.7535 5.49458C13.8008 5.5 13.852 5.49999 13.9545 5.49999H14.8333C15.7667 5.49999 16.2335 5.49999 16.59 5.68165C16.9036 5.84144 17.1586 6.0964 17.3183 6.41001C17.5 6.76653 17.5 7.23324 17.5 8.16666V14.5C17.5 15.4334 17.5 15.9002 17.3183 16.2567C17.1586 16.5702 16.9036 16.8252 16.59 16.985C16.2335 17.1667 15.7667 17.1667 14.8333 17.1667H5.16667C4.23325 17.1667 3.76653 17.1667 3.41002 16.985C3.09641 16.8252 2.84144 16.5702 2.68166 16.2567C2.5 15.9002 2.5 15.4334 2.5 14.5Z" stroke="currentColor" stroke-width="1.06" stroke-linecap="round" stroke-linejoin="round" />
                          </svg>
                          {{ camera.name }}
                        </div>
                      </ng-container>
                    </div>
                  </div>
                </mat-menu>
              </div>
            </div>
          </div>
          <div class="border border-neutral-500-300 rounded-lg overflow-y-auto" style="height: calc(60vh - 180px)">
            <div *ngIf="playback.status === 'Inactive'" class="flex items-center justify-center h-full">The device is offline</div>
          </div>
        </div>
      </ng-template>

      <ng-container *ngIf="playbackScope$ | async as playbackScope; else noScope">
        <ng-container *ngIf="playback.status === 'Active'">
          <div *ngIf="playbackVideoSources$ | async as playbackVideoSources" class="flex flex-col gap-1">
            <ng-container *ngIf="!playbackTimeline.has_video"> </ng-container>
            <ng-container *ngIf="playbackTimeline.has_video">
              <div class="flex flex-row gap-1">
                <div class="flex overflow-x-auto justify-center gap-2">
                  <p class="flex items-center text-sm">Show channels:</p>
                  <ng-container *ngFor="let camera of playbackScope.cameras | slice : 0 : (showAllChannels ? undefined : maxVisibleChannels); trackByField: 'channel'; let i = index">
                    <div
                      *ngIf="{ containsChannel: playbackVideoSources | containsProperty : 'channel' : camera.channel } as ctx"
                      class="flex gap-3 py-2 px-2 rounded-xl cursor-pointer font-normal text-sm select-none text-black items-center"
                      [ngClass]="{
                        'bg-white border border-neutral-500-300': ctx.containsChannel,
                        'bg-neutral-100 border-neutral-500-100': !ctx.containsChannel
                      }"
                      [appTooltip]="!ctx.containsChannel && !handleMaxChannel(ctx.containsChannel, playbackVideoSources) ? 'Maximum 4 cameras can be selected' : undefined"
                      (click)="ctx.containsChannel || handleMaxChannel(ctx.containsChannel, playbackVideoSources) ? handleChannelClick(ctx.containsChannel, camera) : null"
                      (keydown.enter)="ctx.containsChannel || handleMaxChannel(ctx.containsChannel, playbackVideoSources) ? handleChannelClick(ctx.containsChannel, camera) : null">
                      <svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 13.8333C11.3807 13.8333 12.5 12.7141 12.5 11.3333C12.5 9.95258 11.3807 8.83333 10 8.33333C8.61925 8.83333 7.5 9.95258 7.5 11.3333C7.5 12.7141 8.61925 13.8333 10 13.8333Z" stroke="currentColor" stroke-width="1.06" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M2.5 14.5V8.16666C2.5 7.23324 2.5 6.76653 2.68166 6.41001C2.84144 6.0964 3.09641 5.84144 3.41002 5.68165C3.76653 5.49999 4.23325 5.49999 5.16667 5.49999H6.04553C6.14798 5.49999 6.19921 5.5 6.24647 5.49458C6.49305 5.46634 6.71421 5.32965 6.84974 5.12174C6.87572 5.08189 6.89863 5.03606 6.94444 4.94444C7.03608 4.76118 7.08189 4.66955 7.13385 4.58985C7.40492 4.17401 7.84723 3.90064 8.34042 3.84415C8.43492 3.83333 8.53733 3.83333 8.74225 3.83333H11.2577C11.4627 3.83333 11.5651 3.83333 11.6596 3.84415C12.1527 3.90064 12.5951 4.17401 12.8662 4.58985C12.9181 4.66954 12.9639 4.7612 13.0556 4.94444C13.1013 5.03607 13.1242 5.08189 13.1502 5.12174C13.2858 5.32965 13.5069 5.46634 13.7535 5.49458C13.8008 5.5 13.852 5.49999 13.9545 5.49999H14.8333C15.7667 5.49999 16.2335 5.49999 16.59 5.68165C16.9036 5.84144 17.1586 6.0964 17.3183 6.41001C17.5 6.76653 17.5 7.23324 17.5 8.16666V14.5C17.5 15.4334 17.5 15.9002 17.3183 16.2567C17.1586 16.5702 16.9036 16.8252 16.59 16.985C16.2335 17.1667 15.7667 17.1667 14.8333 17.1667H5.16667C4.23325 17.1667 3.76653 17.1667 3.41002 16.985C3.09641 16.8252 2.84144 16.5702 2.68166 16.2567C2.5 15.9002 2.5 15.4334 2.5 14.5Z" stroke="currentColor" stroke-width="1.06" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      {{ camera.name }}
                    </div>
                  </ng-container>

                  <div class="relative">
                    <div [matMenuTriggerFor]="menu" #menuTrigger="matMenuTrigger" (click)="$event.stopPropagation()" (keydown.enter)="$event.stopPropagation()" class="flex items-center gap-1 py-3 px-1.5 rounded-md cursor-pointer hover:bg-neutral-100">
                      <div *ngIf="playbackScope.cameras.length > maxVisibleChannels" class="flex cursor-pointer mr-2 font-medium text-sm select-none items-center">
                        <span class="underline text-brand-500 ml-auto" *ngIf="!showAllChannels">{{ playbackScope.cameras.length - maxVisibleChannels }} {{ showAllChannels ? 'Show Less' : 'more' }}</span>
                      </div>
                    </div>

                    <mat-menu #menu="matMenu" [hasBackdrop]="true">
                      <div class="p-2">
                        <div class="flex flex-col gap-2">
                          <ng-container *ngFor="let camera of playbackScope.cameras | slice : maxVisibleChannels; trackByField: 'channel'">
                            <div
                              *ngIf="{ containsChannel: playbackVideoSources | containsProperty : 'channel' : camera.channel } as ctx"
                              class="flex gap-2 py-2 px-2 rounded-xl cursor-pointer font-normal text-sm border select-none items-center"
                              [ngClass]="{
                                'bg-white border-neutral-500-300': ctx.containsChannel,
                                'bg-neutral-100 border-neutral-500-100': !ctx.containsChannel
                              }"
                              [appTooltip]="!ctx.containsChannel && !handleMaxChannel(ctx.containsChannel, playbackVideoSources) ? 'Maximum 4 cameras can be selected' : undefined"
                              (click)="ctx.containsChannel || handleMaxChannel(ctx.containsChannel, playbackVideoSources) ? handleChannelClick(ctx.containsChannel, camera) : null"
                              (keydown.enter)="ctx.containsChannel || handleMaxChannel(ctx.containsChannel, playbackVideoSources) ? handleChannelClick(ctx.containsChannel, camera) : null">
                              <svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 13.8333C11.3807 13.8333 12.5 12.7141 12.5 11.3333C12.5 9.95258 11.3807 8.83333 10 8.83333C8.61925 8.83333 7.5 9.95258 7.5 11.3333C7.5 12.7141 8.61925 13.8333 10 13.8333Z" stroke="currentColor" stroke-width="1.06" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M2.5 14.5V8.16666C2.5 7.23324 2.5 6.76653 2.68166 6.41001C2.84144 6.0964 3.09641 5.84144 3.41002 5.68165C3.76653 5.49999 4.23325 5.49999 5.16667 5.49999H6.04553C6.14798 5.49999 6.19921 5.5 6.24647 5.49458C6.49305 5.46634 6.71421 5.32965 6.84974 5.12174C6.87572 5.08189 6.89863 5.03606 6.94444 4.94444C7.03608 4.76118 7.08189 4.66955 7.13385 4.58985C7.40492 4.17401 7.84723 3.90064 8.34042 3.84415C8.43492 3.83333 8.53733 3.83333 8.74225 3.83333H11.2577C11.4627 3.83333 11.5651 3.83333 11.6596 3.84415C12.1527 3.90064 12.5951 4.17401 12.8662 4.58985C12.9181 4.66954 12.9639 4.7612 13.0556 4.94444C13.1013 5.03607 13.1242 5.08189 13.1502 5.12174C13.2858 5.32965 13.5069 5.46634 13.7535 5.49458C13.8008 5.5 13.852 5.49999 13.9545 5.49999H14.8333C15.7667 5.49999 16.2335 5.49999 16.59 5.68165C16.9036 5.84144 17.1586 6.0964 17.3183 6.41001C17.5 6.76653 17.5 7.23324 17.5 8.16666V14.5C17.5 15.4334 17.5 15.9002 17.3183 16.2567C17.1586 16.5702 16.9036 16.8252 16.59 16.985C16.2335 17.1667 15.7667 17.1667 14.8333 17.1667H5.16667C4.23325 17.1667 3.76653 17.1667 3.41002 16.985C3.09641 16.8252 2.84144 16.5702 2.68166 16.2567C2.5 15.9002 2.5 15.4334 2.5 14.5Z" stroke="currentColor" stroke-width="1.06" stroke-linecap="round" stroke-linejoin="round" />
                              </svg>
                              {{ camera.name }}
                            </div>
                          </ng-container>
                        </div>
                      </div>
                    </mat-menu>
                  </div>
                </div>
              </div>

              <ng-container *ngIf="playbackScope.cameras.length; else noCamerasTemplate">
                <div class="h-[calc(65vh-200px)]" [ngStyle]="{ 'max-height': playbackVideoSources.length > 1 ? 'calc(65vh - 200px)' : 'auto' }">
                  <app-video-playback *ngIf="playbackVideoSources.length > 0" [cameras]="playbackVideoSources" [provider]="getProvider(playbackVideoSources[0]?.provider)" [beginTime]="playbackBeginTime" [endTime]="playbackEndTime" [timelineStartTime]="getTimelineStart(playbackTimeline)" [timelineEndTime]="getTimelineEnd(playbackTimeline)" [playbackVideoCurrentTime]="(playbackVideoCurrentTime$ | async) || undefined" [playbackParams]="(playbackParams$ | async) || undefined" [showControls]="true" [playType]="'device'" [storeType]="'MASTER'" (stateChange)="handleVideoStateChange($event)" (timeChange)="handleTimeChange($event)" (loadError)="handleVideoLoadError($event)" (loadStart)="handleVideoLoadStart($event)"> </app-video-playback>
                </div>
              </ng-container>
            </ng-container>

            <ng-template #noVideoTemplate>
              <div class="flex w-full">
                <div class="border border-neutral-500-300 rounded-lg p-3 bg-white gap-3 w-full flex flex-col">
                  <p class="font-medium">Unavailable Video</p>
                  <p class="text-sm">Video is unavailable for the selected day or time.</p>
                </div>
              </div>
            </ng-template>

            <ng-template #noCamerasTemplate>
              <p class="font-bold">There are no cameras available</p>
            </ng-template>
          </div>
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
</div>
